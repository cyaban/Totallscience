const categories=["multiplayer","car","casual","action","shooting","puzzle","classic","sport","clicker","escape","2","horror","hard","music","flash"];let token,interval,newGames=[],shouldAutoSwitch=!0,slideIndex=1;const slides=document.getElementsByClassName("featureSlot"),switchSlide=e=>{for(e>slides.length&&(slideIndex=1),e<1&&(slideIndex=slides.length),i=0;i<slides.length;i++)slides[i].style.display="none";slides[slideIndex-1].style.display=""},plusSlides=e=>{shouldAutoSwitch=!1,switchSlide(slideIndex+=e)},autoPlusSlides=e=>{switchSlide(slideIndex+=e)},autoSwitch=()=>{shouldAutoSwitch&&setTimeout((()=>{shouldAutoSwitch&&(switchSlide(slideIndex+=1),autoSwitch())}),2500)};let games,sorted;switchSlide(slideIndex),autoSwitch();let sortObject=e=>Object.keys(e).sort().reduce(((t,a)=>(t[a]=e[a],t)),{});async function loadGames(){let e=await fetch(`assets/games.json?date=${(new Date).getTime()}`);games=await e.json(),sorted=sortObject(games);for(let e in sorted)displayGame(e);if(newGames.length>0){const e=document.getElementById("newGamesCon");document.getElementById("newGamesLabel").style.display="",document.getElementById("newGamesHorizontalCon").style.display="";for(let t=0;t<newGames.length;t++)e.appendChild(createGameButton(newGames[t]))}loadPopularGames(),loadLikedGames(),suggestGames(),addArrowListeners(),findLazyImages()}async function displayGame(e){const t=e,a=sorted[e],n=new Date;n.setDate(n.getDate()-21);new Date(a.date_added)>n&&newGames.push(t);for(let e of categories)a.tags.join(" ").includes(e)&&document.getElementById(`${e}GamesCon`).appendChild(createGameButton(t,"",!0))}async function loadPopularGames(){let e=await fetcher("/stats/games/popular");if(200==e.status){const t=document.getElementById("popularGamesCon");let a=await e.json();for(let e=0;e<15;e++)a[e].game&&t.appendChild(createGameButton(a[e].game,"hot"))}}async function loadLikedGames(){let e=await fetcher("/profile/liked/get");if(200==e.status){const t=document.getElementById("likedGamesCon");let a=await e.json();if(a.length>5)for(like in document.getElementById("likedGamesLabel").style.display="",document.getElementById("likedGamesHorizontalCon").style.display="",a)t.appendChild(createGameButton(a[like]))}}async function loadPartners(){let e=await fetcher("/partners"),t=await e.json();for(let e=0;e<t.length;e++){const a="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1' height='1'%3E%3Crect width='100%25' height='100%25' fill='%23340060'/%3E%3C/svg%3E",n=t[e].name,s=t[e].image,l=t[e].website;let i=document.createElement("div");i.tagName=n,i.id="gameDiv",i.addEventListener("click",(()=>{window.open(l,"_blank")}));let r=document.createElement("div");r.classList="imageCon partner";let o=document.createElement("img");o.classList="lazy partner",o.setAttribute("data-src",s),o.src=a,o.alt=`Totally Science Partner ${n}`,o.title=`Totally Science Partner ${n}`;let d=document.createElement("h1");d.className="innerGameDiv",d.innerText=n,r.appendChild(o),i.appendChild(r),i.appendChild(d),document.getElementById("PartnersCon").appendChild(i)}findLazyImages()}async function loadRewards(){let e=await fetcher("/points/reward/check"),t=await e.text(),a=JSON.parse(t);if(a.isReady){let e=100;a.rewardDay>=6&&(e=1e3),document.getElementById("timerText").innerHTML=`<a onclick="claimReward()" href="javascript:void(null)">Click here</a> to collect your daily reward of ${e} pts!`}else startTimer(a.rewardTime);animateBar(a.rewardDay)}function startTimer(e){clearInterval(interval),document.getElementById("timerText").innerHTML='<span class="loader"></span>Daily Reward In <span id="rewardTimer"></span>',interval=setInterval((()=>{let t=Math.floor(Date.now()/1e3),a=e-t;if(a<0)return document.getElementById("rewardTimer").innerText="00:00:00",void clearInterval(interval);let n=Math.floor(a%60).toString().padStart(2,"0"),s=Math.floor(a/60%60).toString().padStart(2,"0"),l=Math.floor(a/3600%24).toString().padStart(2,"0");document.getElementById("rewardTimer").innerText=l+":"+s+":"+n}),1e3)}function animateBar(e){const t=document.getElementById("rewardDayBar");let a=100/7*(e+1);t.style.width=`${a}%`,t.style.borderTopRightRadius="0px",t.style.borderBottomRightRadius="0px",6==e&&(t.style.borderTopRightRadius="15px",t.style.borderBottomRightRadius="15px")}async function claimReward(){token||(location.href="signup.php"),document.getElementById("timerText").innerHTML='<span class="loader"></span>';let e=await fetcher("/points/reward/claim");if(200==e.status){let t=await e.text(),a=JSON.parse(t);startTimer(a.rewardTime),animateBar(a.rewardDay);let n=document.getElementById("pointsDisplay").innerText;counter("pointsDisplay",parseInt(n),parseInt(n)+parseInt(a.points),2e3),0==a.points&&(document.getElementById("timerText").innerHTML='Oh no! Your daily reward expired.<span class="loader"></span> Next Daily Reward In <span id="rewardTimer"></span>')}}async function suggestGames(){let e=[];if(token){let t=await fetcher("/profile/pinned/get");e=(await t.text()).split(";"),e=e.slice(1)}let t=[];for(let a=0;a<3;a++){let a=randomProperty(games);for(;t.includes(a)||e.includes(a);)a=randomProperty(games);t.push(a)}let a=e.length;if(e.length<3){let a=3-e.length;for(let n=0;n<a;n++){let a=randomProperty(games);for(;t.includes(a)||e.includes(a);)a=randomProperty(games);e.push(a)}}document.getElementById("scisuggests").innerHTML="";for(let n=0;n<3;n++){let s=t[n],l=createGameButton(s,"suggested",!1);document.getElementById("scisuggests").appendChild(l),s=e[n],l=createGameButton(s,n<=a-1?"pin":"suggested",!1),document.getElementById("scisuggests").append(l)}}function createGameButton(e,t,a){const n=games[e];if(null==n)return document.createElement("div");const s=new Date;s.setDate(s.getDate()-21);const l=new Date(n.date_added),i=`location.href = 'class.php?class=${e.replaceAll(" ","-")}'`;let r=document.createElement("div");if(r.setAttribute("tagName",e),r.id="gameDiv",r.classlist=n.tags.join(" "),r.setAttribute("onclick",i),"pin"==t){let e=document.createElement("button");e.id="pin";let t=document.createElement("img");t.src="/assets/images/icons/coloredpin.png",e.appendChild(t),r.appendChild(e)}else if("hot"==t){let e=document.createElement("button");e.id="newbanner";let t=document.createElement("img");t.src="https://totallyscience.co/cdn-cgi/image/height=120,width=220/https:/totallyscience.co/assets/images/icons/hotbanner.png",e.appendChild(t),r.appendChild(e)}else"hidden"==t?r.style.display="none":"suggested"!=t&&r.classList.add("all");if(l>s){r.classList.add("new");let e=document.createElement("button");e.id="newbanner";let t=document.createElement("img");t.src="https://totallyscience.co/cdn-cgi/image/height=120,width=220/https:/totallyscience.co/assets/images/icons/newbanner.png",e.appendChild(t),r.appendChild(e)}let o=a?"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1' height='1'%3E%3Crect width='100%25' height='100%25' fill='%23340060'/%3E%3C/svg%3E":n.image,d=a?"lazy":"",c=document.createElement("div");c.className="imageCon";let m=document.createElement("img");m.setAttribute("data-src",`${n.image.endsWith(".avif")?n.image:"https://totallyscience.co/cdn-cgi/image/height=120,width=220/https://totallyscience.co"+n.image}`),m.src=o,m.alt=`Totally Science ${e}`,m.title=`Totally Science ${e}`,m.className=d,c.appendChild(m),r.appendChild(c);let g=document.createElement("h1");return g.className="innerGameDiv",g.innerText=e,r.appendChild(g),r}async function addArrowListeners(){for(let e=0;e<document.getElementsByClassName("arrowLeftCon").length;e++)document.getElementsByClassName("arrowLeftCon")[e].addEventListener("click",(function(e){const t=e.target.parentNode.parentNode.querySelectorAll(".gamesCon")[0];t.scrollLeft-=Math.min(t.scrollLeft,1100)}));for(let e=0;e<document.getElementsByClassName("arrowRightCon").length;e++)document.getElementsByClassName("arrowRightCon")[e].addEventListener("click",(function(e){const t=e.target.parentNode.parentNode.querySelectorAll(".gamesCon")[0];e.target.parentNode.parentNode.querySelectorAll(".arrowCon")[0].style+="visibility: visible";const a=t.scrollWidth-t.clientWidth-t.scrollLeft;t.scrollLeft+=Math.min(a,1100)}))}async function findLazyImages(){const e=document.querySelectorAll(".lazy"),t=new IntersectionObserver((e=>{e.forEach((e=>{e.isIntersecting&&(e.target.src=e.target.dataset.src,e.target.classList.remove("lazy"),t.unobserve(e.target))}))}),{threshold:.1,rootMargin:"500px 0px"});e.forEach((e=>{t.observe(e)}))}window.addEventListener("load",(async()=>{document.getElementById("gamesnav").classList.add("selected"),loadGames(),loadPartners();let e=await fetcher("/auth/check"),t=await e.text();"A token is required for authentication"==t||"Invalid Token"==t?(token=!1,document.getElementById("timerText").innerHTML='<a href="/signup.php">Sign up</a> to collect your daily reward!'):(token=!0,loadRewards())}));